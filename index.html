<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyQue - Q&A Repository</title>
    <style>
        :root {
            --primary-blue: #0047AB;
            --bg-gray: #D3D3D3;
            --accent-green: #00C853;
            --header-purple: #E1BEE7;
        }

        body { font-family: Arial, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        header { background: var(--header-purple); padding: 15px; text-align: center; font-size: 28px; font-weight: bold; }
        
        .container { display: flex; flex: 1; overflow: hidden; }

        .input-section { background: var(--primary-blue); color: white; width: 40%; padding: 30px; display: flex; flex-direction: column; gap: 10px; box-sizing: border-box; }
        .input-section label { font-weight: bold; font-size: 16px; }
        .input-section input, .input-section select, .input-section textarea {
            width: 100%; padding: 12px; border-radius: 10px; border: none; font-size: 15px; box-sizing: border-box;
        }
        .input-section textarea { height: 200px; resize: none; }
        
        .save-btn { background: var(--accent-green); color: white; padding: 12px; border: none; border-radius: 25px; font-weight: bold; font-size: 18px; cursor: pointer; margin-top: 10px; }

        .display-section { background: var(--bg-gray); width: 60%; padding: 30px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; box-sizing: border-box; }
        .filter-row { display: flex; align-items: center; gap: 15px; }
        .filter-row label { font-weight: bold; min-width: 100px; }
        .filter-row select, .filter-row input { flex: 1; padding: 10px; border-radius: 10px; border: 1px solid #999; }

        .faq-item { margin-bottom: 20px; border-bottom: 1px solid #bbb; padding-bottom: 15px; }
        .question-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .question-link { color: #0047AB; cursor: pointer; text-decoration: underline; font-size: 18px; font-weight: 500; flex: 1; }
        
        .action-btns { display: flex; gap: 10px; font-size: 12px; font-weight: bold; margin-left: 10px; }
        .btn-del { color: red; cursor: pointer; }
        .btn-edit { color: black; cursor: pointer; }

        .answer-box { 
            display: none; background: white; padding: 15px; margin-top: 10px; border-radius: 8px; 
            border-left: 5px solid var(--primary-blue);
            white-space: pre-wrap; 
            line-height: 1.6; color: #333;
        }

        .footer-note { margin-top: auto; text-align: center; font-size: 14px; padding: 20px; }
    </style>
</head>
<body>

<header>Qmodify - FAQ</header>

<div class="container">
    <div class="input-section">
        <label>Enter the question</label>
        <input type="text" id="qInput" placeholder="Type question here...">

        <label>Type of Question</label>
        <select id="typeInput">
            <option>Related to App use</option>
            <option>Related to App tech</option>
            <option>Related to payments</option>
            <option>Promotion & Marketing</option>
            <option>Query & Complaints</option>
            <option>Admin only</option>
            <option>Related to app features</option>
            <option>Common user queries</option>
        </select>

        <label>Enter Answer</label>
        <textarea id="aInput" placeholder="Enter solution with lines and spacing..."></textarea>

        <button id="mainBtn" class="save-btn" onclick="handleSave()">Save</button>
        <input type="hidden" id="editRowId">
    </div>

    <div class="display-section">
        <div class="filter-row">
            <label>Select Type</label>
            <select id="typeFilter" onchange="fetchData()">
                <option value="">-- Choose Category --</option>
                <option>Related to App use</option>
                <option>Related to App tech</option>
                <option>Related to payments</option>
                <option>Promotion & Marketing</option>
                <option>Query & Complaints</option>
                <option>Admin only</option>
                <option>Related to app features</option>
                <option>Common user queries</option>
            </select>
        </div>
        <div class="filter-row">
            <label>Search Question</label>
            <input type="text" id="searchBar" onkeyup="searchLocally()" placeholder="Keywords...">
        </div>

        <div id="faqList"></div>
    </div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbwiQg6_DRICn6w166CTuwyH-am8866ZgCBrELcqJu3Xx0ZiYupZOKCOY4qtRV_2yk7z/exec";
    const PASS = "Mylefin@141";
    let masterData = [];

    async function fetchData() {
        const type = document.getElementById('typeFilter').value;
        if (!type) return;

        if (type === "Admin only") {
            if (prompt("Enter Admin Password:") !== PASS) {
                alert("Access Restricted");
                document.getElementById('typeFilter').value = "";
                return;
            }
        }

        document.getElementById('faqList').innerHTML = "Loading...";
        try {
            const res = await fetch(API);
            masterData = await res.json();
            searchLocally();
        } catch (e) {
            document.getElementById('faqList').innerHTML = "Error connecting to cloud.";
        }
    }

    function searchLocally() {
        const type = document.getElementById('typeFilter').value;
        const term = document.getElementById('searchBar').value.toLowerCase();
        const filtered = masterData.filter(d => d.type === type && d.question.toLowerCase().includes(term));
        
        document.getElementById('faqList').innerHTML = filtered.map((item, i) => `
            <div class="faq-item">
                <div class="question-header">
                    <span class="question-link" onclick="toggle(${i})">${i + 1}. ${item.question}</span>
                    <div class="action-btns">
                        <span class="btn-del" onclick="deleteItem(${item.rowId})">Delete</span>
                        <span class="btn-edit" onclick="startEdit(${JSON.stringify(item).replace(/"/g, '&quot;')})">Edit</span>
                    </div>
                </div>
                <div id="ans-${i}" class="answer-box">${item.answer}</div>
            </div>
        `).join('');
    }

    function toggle(i) {
        const el = document.getElementById(`ans-${i}`);
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
    }

    async function handleSave() {
        const rowId = document.getElementById('editRowId').value;
        const action = rowId ? "edit" : "save";
        const body = new URLSearchParams({
            action: action,
            rowId: rowId,
            type: document.getElementById('typeInput').value,
            question: document.getElementById('qInput').value,
            answer: document.getElementById('aInput').value
        });

        document.getElementById('mainBtn').innerText = "Processing...";
        await fetch(API, { method: 'POST', mode: 'no-cors', body: body });
        
        alert("Action completed successfully!");
        resetForm();
        fetchData();
    }

    async function deleteItem(rowId) {
        if (prompt("Enter Admin Password to DELETE:") !== PASS) return alert("Wrong Password!");
        if (!confirm("Confirm Delete?")) return;

        // Use URLSearchParams to ensure Google Script reads parameters correctly
        const params = new URLSearchParams();
        params.append('action', 'delete');
        params.append('rowId', rowId);

        await fetch(API, { method: 'POST', mode: 'no-cors', body: params });
        alert("Deleted from Google Sheet!");
        fetchData();
    }

    function startEdit(item) {
        if (prompt("Enter Admin Password to EDIT:") !== PASS) return alert("Wrong Password!");
        
        document.getElementById('typeInput').value = item.type;
        document.getElementById('qInput').value = item.question;
        document.getElementById('aInput').value = item.answer;
        document.getElementById('editRowId').value = item.rowId;
        document.getElementById('mainBtn').innerText = "Update Now";
        document.getElementById('mainBtn').style.background = "#FF9800";
    }

    function resetForm() {
        document.getElementById('qInput').value = "";
        document.getElementById('aInput').value = "";
        document.getElementById('editRowId').value = "";
        document.getElementById('mainBtn').innerText = "Save";
        document.getElementById('mainBtn').style.background = "var(--accent-green)";
    }
</script>
</body>
</html>